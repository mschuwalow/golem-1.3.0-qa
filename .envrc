use flake "$DEV_SHELLS_ROOT/golem"
if [ "${NIX_DIRENV_DID_FALLBACK+x}" ]; then echo "Failed to load nix devshell" && exit 1; fi

export CARGO_INSTALL_ROOT="$PWD/.cargo"
PATH_add "$CARGO_INSTALL_ROOT/bin"

local extra_bins="$PWD/.direnv/extra/bin"
mkdir -p $extra_bins
PATH_add $extra_bins

# setup golem
{
  local golem_bin_path="$extra_bins/golem"
  if [ ! -f "$golem_bin_path" ]; then
    local cached_path
    if [ "$NIX_SYSTEM" = "x86_64-linux" ]
    then
        cached_path=$(fetchurl "https://github.com/golemcloud/golem/releases/download/v1.3.0-rc1/golem-x86_64-unknown-linux-gnu" "sha256-5oyZdy6SvMTxRJziL8wODB3Wmh8yuIbDKGRQbFKXvlc=")
    elif [ "$NIX_SYSTEM" = "aarch64-darwin" ]
    then
        cached_path=$(fetchurl "https://github.com/golemcloud/golem/releases/download/v1.3.0-rc1/golem-aarch64-apple-darwin" "sha256-v7V1ZCyDkoOTcHQSs0J/3MUlwSd3LFuJSLZgqGyyHMI=")
    else
        echo "Unsupported platform $NIX_SYSTEM" && exit 1
    fi

    cp "$cached_path" "$golem_bin_path"
    chmod +x "$golem_bin_path"
  fi
}


export RUST_BACKTRACE=1
export RUST_LOG=debug
